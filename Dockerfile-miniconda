FROM ubuntu:20.04

# Set environment variables to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC

# Install basic dependencies with cleanup
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    git build-essential cmake libssl-dev curl \
    gcc-arm-none-eabi binutils-arm-none-eabi \
    libclang-dev clang pkg-config wget bzip2 ca-certificates tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh

ENV PATH="/opt/conda/bin:$PATH"

# Copy your application files
COPY . /work/
WORKDIR /work

# Accept Conda Terms of Service before creating environment
RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# Create conda environment
RUN conda env create -f environment.yml

# Install Rust
RUN curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain nightly -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Set up Rust tools
RUN /bin/bash -c "source /root/.cargo/env && \
    rustup component add llvm-tools-preview && \
    cargo install cargo-binutils"

# Activate conda environment by default
RUN echo "source activate $(head -1 environment.yml | cut -d' ' -f2)" >> ~/.bashrc

# Update the system
RUN apt update

# Install Rust
# Install Rust and tools (all in one RUN to reduce layers)
RUN curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain nightly -y && \
    . /root/.cargo/env && \
    rustup component add llvm-tools-preview && \
    cargo install cargo-binutils && \
    rustup target add thumbv7em-none-eabihf
	
# Targets and tools from cargo
RUN cargo install cargo-binutils
RUN rustup target add thumbv7em-none-eabihf
RUN rustup component add llvm-tools-preview

CMD ["/bin/bash"]